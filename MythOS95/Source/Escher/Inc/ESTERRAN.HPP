//
//
//
//
//
//
//
//
//
//
//Copyright(c)1994-1997byCharybdisEnterprises,Inc.
//AllRightsReserved.
//
// Microsoft Windows '95 Version 
//
//
//
//           *** Charybdis Enterprises, Inc. Company Confidential ***
//
//  This file and all associated files are the company proprietary property
//        of Charybdis Enterprises, Inc.  Unauthorized use prohibited.
//
// CHARYBDIS ENTERPRISES, INC. MAKES NO WARRANTIES, EXPRESS OR IMPLIED, AS
// TO THE CORRECTNESS OF THIS CODE OR ANY DERIVATIVE WORKS WHICH INCORPORATE
// IT.  CHARYBDIS ENTERPRISES, INC. PROVIDES THE CODE ON AN "AS-IS" BASIS
// AND EXPLICITLY DISCLAIMS ANY LIABILITY, INCLUDING CONSEQUENTIAL AND
// INCIDENTAL DAMAGES FOR ERRORS, OMISSIONS, AND OTHER PROBLEMS IN THE CODE.
//
//
//
// Created by Tim Little & Chuck Walbourn
//
// esterran.hpp
//
// The EschTerrain class is a height-field polygonal terrain system which
// uses a 2D array of 8-bit height values to create a realistic "outdoor"
// terrain.  The terrain may have textures and be drawn with multiple
// levels of detail.
//
//

#ifndef __ESTERRAN_HPP
#define __ESTERRAN_HPP    1

#ifdef __WATCOMC__
#pragma pack(1);
#endif

#ifdef _MSC_VER
#pragma pack(push,1)
#endif

//
//
//                                Includes
//
//

#include <portable.h>

#include "esmath.hpp"
#include "esdraw.hpp"

//
//
//                                Equates
//
//

#define TESTING_TERRAIN
#define ESCH_LOW_TERRAIN_X_PRIMARY  0x1
#define ESCH_LOW_TERRAIN_Z_PRIMARY  0x2
#define ESCH_MAX_LOD                8

//
//
//                               Structures
//
//

struct esch_surf_type
{
    ushort  flags;                          // Surface flags
    byte    shd;                            // Shade level
    byte    cind;                           // Color index
};

//
//
//                                Classes
//
//

//Ŀ
// EschTerrain - Height-field terrain drawable object.                      
//                                                                          
// Terrain is assumed to start at the origin and extends out along the XZ   
// plane, with heights in positive Y.                                       
//
class EschTerrain : public EschDrawable
{
protected:

    int compute_area(float lox, float loz, float hix, float hiz,
                     int *sw, int *ew, int *sd, int *ed, int bits);

    int compute_shift_value(ulong x, ulong *shift);

    void compute_texture_uv(float &u_left, float &u_right,
                            float &v_top, float &v_bottom,
                            dword flags,
                            int w, int d,
                            ulong shift=0);

    void draw_block(int w, int d, int i, int j,
                    esch_surf_type *sptr, dword ctrlfl,
                    ulong shift=0);


    enum
    {
        BOTTOM          =0,
        TOP             =1,
        LEFTA           =2,
        LEFTB           =3,
        RIGHTA          =4,
        RIGHTB          =5,
        BOTTOM_CORNERS  =6,
        TOP_CORNERS     =7,
    };

    void draw_transitions(int w, int d, int i, int j,
                          esch_surf_type *sptr, dword ctrlfl,
                          int id,
                          ulong shift=0);

    //Ŀ
    // Protected data members                                               
    //
    char            iname[ESCH_MAX_NAME];

public:
    //Ŀ
    // Public data members                                                  
    //
    ushort          width;                  // Width of height field
    ushort          depth;                  // Depth of height field
    ulong           surfratio;              // Surface ratio (height : surface)
    ulong           surfshift;              // Shift value for surf ratio
    float           scale;                  // World space per unit in width/depth
    ulong           scaleshift;             // Shift value for scale
    float           lodmedium;              // Eye distance for medium LOD
    float           lodlow;                 // Eye distance for low LOD
    EschPoint       origin;                 // Origin of height field
    byte            *hfield;                // 2D array of heights
    float           *htable;                // Array of world height values
    esch_surf_type  *surfinfo;              // 2D array of surface information
    IvoryHandle     hsurfnorml;             // 2D array of surface normals
    ulong           tmax;                   // Number of textures
    byte            *txtcolor;              // Array of colors to use for texture entries
    EschTexture     **txt;                  // Array of textures

    //Ŀ
    // Constructor/Destructors                                              
    //
    EschTerrain(const char *fname=0, const char *tname=0);

    virtual ~EschTerrain();

    //Ŀ
    // Operations                                                           
    //
    const EschTerrain &operator = (const EschTerrain &t);

    virtual void draw();
    virtual void animate();

    virtual void compute_shades(EschCamera *cam, EschLight *lgts);

    virtual void release();

    virtual float get_height(float x, float z) const;
    float get_height(const EschPoint *pt) const
    {
        return get_height(pt->x, pt->z);
    }

    virtual ushort get_surface_flags(float x, float z) const;
    ushort get_surface_flags(const EschPoint *pt) const
    {
        return get_surface_flags(pt->x, pt->z);
    }

    virtual int check_LOS(EschPoint *pt1, EschPoint *pt2, int precision=-1,float *dist=NULL) const;

    //Ŀ
    // Utility functions.                                                   
    //
    void set_origin(const EschPoint *pt)
    {
        origin = *pt;
    }
    void set_origin(const float ix, const float iy, const float iz)
    {
        origin.x = ix;
        origin.y = iy;
        origin.z = iz;
    }

    void set_scale(const float i);

    void set_lod(const float lodm, const float lodl)
    {
        lodmedium = (lodm <= 0) ? 0 : lodm;
        lodlow = (lodl < lodmedium) ? lodmedium : lodl;
        flags |= ESCH_TRN_LOD;
    }

    //Ŀ
    // I/O routines                                                         
    //
    virtual esch_error_codes load(const char *fname, const char *tname=0, ushort *hclr=0);
    virtual esch_error_codes load(XFParseIFF *iff, const char *tname=0, ushort *hclr=0);
};


//Ŀ
// EschTerrainEx - Height-field terrain drawable object.                    
//
class EschTerrainEx : public EschTerrain
{
public:
    enum
    {
        ESCH_TERNEX_SMOOTH_NONE     = 0x0,
        ESCH_TERNEX_SMOOTH_TOP      = 0x1,
        ESCH_TERNEX_SMOOTH_BOTTOM   = 0x2,
        ESCH_TERNEX_SMOOTH_LEFT     = 0x4,
        ESCH_TERNEX_SMOOTH_RIGHT    = 0x8,
        ESCH_TERNEX_SMOOTH_ALL      = ESCH_TERNEX_SMOOTH_TOP
                                    | ESCH_TERNEX_SMOOTH_BOTTOM
                                    | ESCH_TERNEX_SMOOTH_LEFT
                                    | ESCH_TERNEX_SMOOTH_RIGHT,

        ESCH_TERNEX_CLIP            =0x10,
        ESCH_TERNEX_ALIGN           =0x20,
        ESCH_TERNEX_TEXTURE         =0x40,
        ESCH_TERNEX_PERSPECTIVE     =0x80,
        ESCH_TERNEX_SMOOTH          =0x100
    };

protected:
    //Ŀ
    // Protected data members                                               
    //

//    EschPoint   dvolume[10];
    long        *left_edge;
    long        *right_edge;
    long        edge_count;
    VngoRect    darea;
    int         ccol;   // colomn coord in array.
    int         crow;   // row coord in array.
    int         max_texture_lod;
    int         max_perspective_lod;
    int         max_smooth_lod;
    int         num_dlevels;
    int         start_dlevel;
    float       *dlevels;
    dword       view_dir;

    EschCamera  *cam;
    dword       cflags;
    EschPoint   pos;
    EschPoint   po;

    EschVector  wvec;
    EschVector  dvec;
    EschVector  hvec;

    void esch_find_draw_volume();
    VngoRect draw_terrain_rect(VngoRect *iclip, VngoRect *oclip,int dlevel,dword flags);
    void draw_terrain_rect(VngoRect *iclip, int dlevel, dword flags);
    void display_pixel_row(VngoPoint *vpt, int count);
    void setup_edge_limits(VngoPoint *edge);
    void add_edge_to_limits(VngoPoint *p1,VngoPoint *p2);

public:
    //Ŀ
    // Public data members                                                  
    //
    EschTerrainEx (const char *fname=0, const char *tname=0);
    EschTerrainEx (const EschTerrainEx &_t);
    virtual ~EschTerrainEx();

    //Ŀ
    // Operations                                                           
    //
    virtual void draw();

    virtual float get_height(float x, float z) const;
    virtual void set_lod (int count,...);
    virtual void set_texture_lod(int lod);
    virtual void set_perspective_lod(int lod);
    virtual void set_smooth_lod(int lod);
    virtual void set_start_lod(int lod);

    float *get_dlevels () {return dlevels;}
    int get_texture_lod() {return max_texture_lod;}
    int get_perspective_lod() {return max_perspective_lod;}
    int get_smooth_lod() {return max_smooth_lod;}
    int get_start_lod() {return start_dlevel;}
    int get_num_lod() {return num_dlevels;}
    void hide_rect(VngoRect &hrect);

    virtual void release();
};

#ifdef __WATCOMC__
#pragma pack();
#endif

#ifdef _MSC_VER
#pragma pack(pop)
#endif

#endif

// End of header - esterran.hpp 

