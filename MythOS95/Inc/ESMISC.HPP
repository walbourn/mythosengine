//
//
//
//
//
//
//
//
//
//
//Copyright(c)1994-1996byCharybdisEnterprises,Inc.
//AllRightsReserved.
//
// Microsoft Windows '95 Version 
//
//
//
//           *** Charybdis Enterprises, Inc. Company Confidential ***
//
//  This file and all associated files are the company proprietary property
//        of Charybdis Enterprises, Inc.  Unauthorized use prohibited.
//
// CHARYBDIS ENTERPRISES, INC. MAKES NO WARRANTIES, EXPRESS OR IMPLIED, AS
// TO THE CORRECTNESS OF THIS CODE OR ANY DERIVATIVE WORKS WHICH INCORPORATE
// IT.  CHARYBDIS ENTERPRISES, INC. PROVIDES THE CODE ON AN "AS-IS" BASIS
// AND EXPLICITLY DISCLAIMS ANY LIABILITY, INCLUDING CONSEQUENTIAL AND
// INCIDENTAL DAMAGES FOR ERRORS, OMISSIONS, AND OTHER PROBLEMS IN THE CODE.
//
//
//
// Created by Tim Little & Chuck Walbourn
//
// esmisc.hpp
//
// Contains miscellaneous classes for use with Escher.
//
// EschStarfield is a space 'starfield' drawable.
//
// EschFireTexture is an animated procedural texture for flame.
//
// EschPlosion is a 'fire-tree' drawable which uses the EschFireTexture
// to create an explosion.
//
//

#ifndef __ESMISC_HPP
#define __ESMISC_HPP    1

#ifdef __WATCOMC__
#pragma pack(1);
#endif

#ifdef _MSC_VER
#pragma pack(push,1)
#endif

//
//             
//                                Includes
//                                
//

#include "estxture.hpp"

//
//
//                                Classes
//
//

//Ŀ
// EschStarfield - Space 'starfield' drawable.                              
//
class EschStarfield : public EschDrawable
{
public:
    //Ŀ
    // Public data members                                                  
    //
    ulong       count;
    EschPoint   *stars;
    dword       *brightness;
    dword       color;

    //Ŀ
    // Constructor/Destructors                                              
    //
    EschStarfield() :
        EschDrawable(ESCH_DRWT_STARFIELD),
        stars(0),
        brightness(0) {};

    virtual ~EschStarfield();

    //Ŀ
    // Operations                                                           
    //
    virtual void draw();

    virtual void release();

    //Ŀ
    // Utility functions.                                                   
    //
    void set_color(dword c) { color=c; }

    esch_error_codes create_stars(ulong c, int dobrights=1);
};


//Ŀ
// EschFireTexture - Procedural fire texture.                               
//
class EschFireTexture : public EschProceduralTexture
{
    int     u_shift;
    int     decay;
    int     more_fire;
    int     fb_control;
    int     taper;
    byte    *flame_bytes;
    byte    *flames;

    //Ŀ
    // Private color translation tables.                                    
    //
    byte    *write_lut;

    //Ŀ
    // Private utility functions.                                           
    //

    esch_error_codes setup_local_tables();

    void smooth_baseline();
    byte get ( int u, int v );
    void put ( int u, int v, int intensity );

    void MakeMockPal(VngoPal *vpal);
    void Hsi2Rgb (Flx16 H, Flx16 S, Flx16 I, VngoColor24bit &C);

public:
    //Ŀ
    // Constructor/Destructors                                              
    //
    EschFireTexture();
    EschFireTexture(ushort w, ushort h, VngoPal *pal, int dogen=1);

    virtual ~EschFireTexture();

    //Ŀ
    // Operations                                                           
    //
    virtual void release();
    virtual esch_error_codes init(ushort w, ushort h, VngoPal *pal,
                                  int dogen=1);
    virtual void generate();

    //Ŀ
    // Utility functions.                                                   
    //
    void increase(int amount=2) 
    {
        if (more_fire + amount < 20)
           more_fire += amount;
        else
           more_fire = 20;
    }
    void decrease(int amount=2) 
    {
        if (more_fire - amount > -20)
           more_fire -= amount;
        else
           more_fire = -20;
    }

    void ignite();
    void douse(int smooth_it=1);
    void fireball(int start_fireball=1);
};


//Ŀ
// EschPlosion - A explosion effect drawable.                               
//
class EschPlosion : public EschDrawable
{
protected:
    EschFrameRef    world;
    EschFireTexture *fire;
    Flx16           step;
    Flx16           fv;

    void check_workspace();

public:
    //Ŀ
    // Public data members                                                  
    //
    Flx16   width;
    Flx16   height;

    //Ŀ
    // Constructor/Destructors                                              
    //
    EschPlosion() : EschDrawable(ESCH_DRWT_EXPLOSION), fire(0), fv(1) {}

    EschPlosion(Flx16 w, Flx16 h, EschFireTexture *f);

    virtual ~EschPlosion() {}

    //Ŀ
    // Operations                                                           
    //
    virtual void draw();
    virtual void animate();

    //Ŀ
    // Utility functions.                                                   
    //
    void get_position(EschPoint *p) const
    {
        world.get_position(p);
    }

    void set_position(Flx16 ix, Flx16 iy, Flx16 iz)
    {
        world.set_position(ix, iy, iz);
    }
    void set_position(EschPoint *pnt)
    {
        world.set_position(pnt->x, pnt->y, pnt->z);
    }

    void set_top(EschVector *v);
    void set_top(Flx16 ii, Flx16 ij, Flx16 ik);

    void set_direction(EschVector *v);
    void set_direction(Flx16 ii, Flx16 ij, Flx16 ik);

    void set_size(Flx16 w, Flx16 h)
    {
        width=w;
        height=h;
    }

    void set_fire(EschFireTexture *f) { fire=f; }

    void set_step(Flx16 i) { step=i; }

    void reset() { fv=Flx16(1); }
};

#ifdef __WATCOMC__
#pragma pack();
#endif

#ifdef _MSC_VER
#pragma pack(pop)
#endif

#endif

// End of header - esmisc.hpp 

